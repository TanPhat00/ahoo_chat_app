<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat 1-1 (Demo Telegram)</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    .user-list, #messages { margin-bottom: 20px; }
    .user { cursor: pointer; color: blue; margin-bottom: 5px; }
    .chat-box { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; }
  </style>
</head>
<body>

  <h2>🔗 Chat 1-1 Test</h2>

  <!-- User đang đăng nhập -->
  <input type="hidden" id="currentUserId" value="687108d7c9f5e73fd7e05e59">

  <div class="user-list">
    <strong>Danh sách người dùng:</strong>
    <div class="user" onclick="startChatWith('6871083dcc221a0f4c311d5e')">👤 User B (tanphat)</div>
    <div class="user" onclick="startChatWith('687108d7c9f5e73fd7e05e59')">👤 User A (t.hnhi)</div>
  </div>

  <div><strong>Đang chat với:</strong> <span id="chatWith">Chưa chọn</span></div>
  <div class="chat-box" id="messages"></div>

  <input type="text" id="messageInput" placeholder="Nhập tin nhắn..." style="width: 300px">
  <button onclick="sendMessage()">Gửi</button>

  <script>
    const socket = io("http://localhost:3000", { transports: ["websocket"] });
    let currentRoomId = null;

    socket.on("connect", () => {
      console.log("✅ Socket connected:", socket.id);
    });

    function startChatWith(otherUserId) {
      const currentUserId = document.getElementById("currentUserId").value;
      const token = "Bearer 8128|6ece12f3343f335071f9362a9c2186bb2b0958b855977dcb"; // TOKEN user A
      document.getElementById("chatWith").textContent = otherUserId;

      fetch("http://localhost:3000/api/chat/create-or-get-room", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": token
        },
        body: JSON.stringify({ otherUserId })
      })
      .then(res => res.json())
      .then(data => {
        currentRoomId = data.roomId;
        console.log("👉 Tham gia room:", currentRoomId);
        socket.emit("chat:joinRoom", currentRoomId);
        document.getElementById("messages").innerHTML = "";

        // Load tin nhắn cũ
        fetch(`http://localhost:3000/api/chat/${currentRoomId}/messages`, {
          headers: { Authorization: token }
        })
          .then(res => res.json())
          .then(msgData => {
            msgData.messages.forEach(m => {
              addMessageToUI(m.sender.username || m.sender._id, m.content);
            });
          });
      });
    }

    function sendMessage() {
      const content = document.getElementById("messageInput").value;
      const senderId = document.getElementById("currentUserId").value;

      if (!content || !currentRoomId) return alert("Chưa có phòng hoặc tin nhắn rỗng");

      socket.emit("chat:sendMessage", {
        roomId: currentRoomId,
        message: {
          sender: { _id: senderId },
          content: content,
          type: "text"
        }
      });

      document.getElementById("messageInput").value = '';
    }

    socket.on("chat:receiveMessage", ({ message }) => {
      addMessageToUI(message.sender.username || message.sender._id, message.content);
    });

    function addMessageToUI(sender, content) {
      const div = document.createElement("div");
      div.textContent = `${sender}: ${content}`;
      document.getElementById("messages").appendChild(div);
    }
  </script>

</body>
</html>
